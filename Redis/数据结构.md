Redis底层有6种数据结构：简单动态字符串、双向链表、压缩列表、哈希表、跳表、整数数组。

数据类型与数据结构关系如下图。

![image-20210315121911318](https://img.jooks.cn/img/20210315121911.png)

## 键和值用什么结构组织？

为了实现从键到值的快速访问，Redis 使用了一个哈希表来保存所有键值对。

![image-20210315122108809](https://img.jooks.cn/img/20210315122108.png)

## 哈希冲突

Redis 解决哈希冲突的方式，就是链式哈希。

## Rehash（渐进式）

当哈希桶中的链表过长时，会极大影响效率，故rehash增加哈希桶数量。

为了使 rehash 操作更高效，Redis 默认使用了两个全局哈希表。一开始，当你刚插入数据时，默认使用哈希表 1，此时的哈希表 2 并没有被分配空间。随着数据逐步增多，Redis 开始执行 rehash，这个过程分为三步：

1. 给哈希表 2 分配更大的空间，例如是当前哈希表 1 大小的两倍；
2. 把哈希表 1 中的数据重新映射并拷贝到哈希表 2 中；但此时Redis仍然正常处理客户端请求，每处理一个请求时，从哈希表1中的第一个索引位置开始，顺带着将这个索引位置上的所有 entries 拷贝到哈希表 2 中；等处理下一个请求时，再顺带拷贝哈希表 1 中的下一个索引位置的 entries。
3. 释放哈希表 1 的空间。

## 压缩列表

压缩列表实际上类似于一个数组，数组中的每一个元素都对应保存一个数据。和数组不同的是，压缩列表在表头有三个字段 zlbytes、zltail 和 zllen，分别表示列表长度、列表尾的偏移量和列表中的 entry 个数；压缩列表在表尾还有一个 zlend，表示列表结束。

在压缩列表中，如果我们要查找定位第一个元素和最后一个元素，可以通过表头三个字段的长度直接定位，复杂度是 O(1)。而查找其他元素时，就没有这么高效了，只能逐个查找，此时的复杂度就是 O(N) 了。

## 跳表

跳表在链表的基础上，增加了多级索引，通过索引位置的几个跳转，实现数据的快速定位。

![image-20210315124312387](https://img.jooks.cn/img/20210315124312.png)

当数据量很大时，跳表的查找复杂度就是 O(logN)。

## 查找单个元素的时间复杂度

![image-20210315124408547](https://img.jooks.cn/img/20210315124408.png)

## 范围查询

这类操作的复杂度一般是 O(N)，比较耗时，我们应该尽量避免。

## 统计操作

统计操作，是指集合类型对集合中所有元素个数的记录。

当集合类型采用压缩列表、双向链表、整数数组这些数据结构时，这些结构中专门记录了元素的个数统计，这类操作复杂度只有 O(1)。

