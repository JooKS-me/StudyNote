> Redis的高可靠有两层含义：
>
> 一、数据尽量减少丢失；（ AOF，RDB）
>
> 二、服务尽量减少中断。（集群模式）

## 读写分离

在主从模式下，读操作在主库和从库都可以进行，但是写操作只能打在主库上，然后同步给从库。

具体同步过程：

主库维护一个缓冲区叫repl_backlog_buffer，这是一个环形缓冲区，主库使用master_repl_offset记录自己写到的位置，从库用slave_repl_offset记录自己复制到的位置。

如果主从断连，主库会继续往下写，当主从恢复连接时，若master_repl_offset没有赶上slave_repl_offset，则进行增量复制；若赶上，则表示已经产生覆盖，则需要全量复制。

## 主从的首次连接

首次连接分三步走。（全量复制）

1. 建立连接，协商同步。
   - 从机向主机发送psync
   - 主机收到后向从机发送runID和复制进度
2. 主库执行bgsave命令，然后将生成的RDB文件传给从库，从库接收后清空当前数据，然后加载RDB文件。
   - 这个过程中，主库接收到写操作时，会将写操作写入replication buffer中。
3. 将replication buffer中的数据传给从库

## 主从级连模式

虽然执行全量复制的过程不是主进程在做，但是主进程（单线程）fork子进程会有开销，而且传输rdb文件也会占用带宽。当从库过多时，就会影响主线程的正常工作。

此时，可以采用主从级联模式，如下图。

![image-20210317180725876](https://img.jooks.cn/img/20210317180725.png)

通过“主 - 从 - 从”模式将主库生成 RDB 和传输 RDB 的压力，以级联的方式分散到从库上。

## 哨兵机制

哨兵三个职责：监控、选主、通知。

- 监控：哨兵进程在运行时，周期性给主从库发送PING命令，来检测redis是否在线。
  - 若发现从库没有反应，则直接判定为“主观下线”
  - 若发现主库没有反应，则哨兵集群进行投票判断主库是否下线，若多数哨兵认为主库不在线，那就判定为“客观下线”，进行后面的选主操作。
    - 任何一个哨兵，只要自身判断主库“主观下线”后，就会给其他哨兵发送is-master-down-by-addr命令。接着，其他哨兵会根据自己和主库的连接情况，作出Y或N的响应，Y表示赞成，N表示反对。这个所需的赞成票数是通过哨兵配置文件中的 quorum 配置项设定的。
    - 接着进行Leader投票，选出最终执行主从切换的哨兵。
- 选主：先对从库进行筛选，筛掉不在线的、网络总是断连的丛库。然后进行三轮打分。
  - 第一轮给从库的优先级打分，若产生得分相同，进入下一轮打分。
  - 第二轮看slave_repl_offset，slave_repl_offset大的被选中，若还有相同进入下一轮。
  - 第三轮ID号小的从库得分高。
- 通知：选出新主库后，通知从库和客户端。

哨兵之间通过订阅主库的一个\__sentinel__:hello频道来获取其他哨兵节点的IP和端口号，然后哨兵之间建立通信。

哨兵通过向主库发送INFO命令来获取从库的信息。

## 切片集群











