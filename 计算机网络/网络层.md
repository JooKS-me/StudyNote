网络层的功能：

1. 路由选择与分组转发
2. 异构网络互联
3. 拥塞控制

## 数据交换方式

1. 电路交换

2. 报文交换：存储转发，动态分配路线。数据块可能太大

3. 分组交换：把大的数据块分割成小的数据块

   - 数据报方式：无连接服务（因特网在用），不同分组传输路径可能不同 
     - 每个分组携带源和目标地址
     - 路由器基于路由协议/算法构建转发表，然后检索转发表，为每个分组独立选路  

   - 虚电路方式：连接服务

![image-20210331172530806](https://img.jooks.cn/img/20210331172530.png)

## 路由算法与路由协议

静态路由算法：管理员手工配置路由信息，路由更新慢，不适合大型网络

动态路由算法：

#### 内部网关协议IGP

- RIP
  - 网络中每一个路由器都维护从它到其他 **每一个** 目的网络的 **唯一最佳距离记录**
  - 通过路由器间交换路由表
    - 仅和相邻路由器交换信息
    - 每30秒交换一次
  - RIP协议只适用于 **小互联网**

- **OSPF（开放式最短路径优先协议）**

  - 使用Dijkstra最短路径算法
  - 通过 **洪犯法** 向自治系统内所有路由器发送信息，收到信息的路由器又再次将此信息发往所有相邻的路由器。
  - 发送的信息是与本路由器相邻的所有路由器的链路状态（本路由器与哪些路由器相邻，以及该链路的度量——费用、距离、时延、带宽等）
  - 当链路状态发送变化时，才发送信息
  - 最后所有路由器都能建立一个**链路状态数据库**，即**全网拓扑图**。
  - 直接使用IP数据报传递

- OSPF的区域

  - 将一个自治系统再划分为若干个更小的范围，叫做区域

    ![image-20210331220744196](https://img.jooks.cn/img/20210331220744.png)

  - **使得OSPF区域内部的信息交换的次数大大减小，使得OSPF适用于规模较大的系统**

#### 外部网关协议EGP

- BGP协议

  - 应用层协议，借助TCP传送。

  - 与邻站BGP发言人交换网络可达性的信息（即要到达某个网络所要经历的一系列AS）。
  - **BGP只是力求找到一个可以到达目的网络且比较好的路由，而并不是寻找一条最佳路由**
  - 首次交换整个路由表，之后发生变化的时候更新有变化的部分。

## IP数据报格式

![image-20210331175538353](https://img.jooks.cn/img/20210331175538.png)

版本：4位，IPV4/PV6?

首部长度：4位，单位为4B，从5开始（即固定部分最小为20B）

总长度：首部+数据的长度，单位为1B

生存时间（TTL）：IP分组的保质期。经过一个路由器-1，变成0则丢弃

协议：8位，表示数据部分的协议。TCP是6，UDP是17，ICMP是1。

首部检验和：只检验首部。

填充：全0，把首部补成4B的整数倍。

**标识：同一数据报的分片使用同一标识。**

**标志：只有2位有意义，中间位DF（Don't Fragment）表示是否允许分片；最低位MF（More Fragment）表示后面是否还有分片。**

## IP地址

![image-20210331183215534](https://img.jooks.cn/img/20210331183215.png)

问：127.0.0.1与0.0.0.0的区别？

答：

127.0.0.1是环回地址，是在主机内发送数据包，可以作为IP分组源地址，也可以作为IP分组目的地址。

0.0.0.0在局域网范围内表示本机，在路由表中表示默认路由，可以作为IP分组的源地址，但不能作为IP分组目的地址。（服务器场景）

![image-20210331184057848](https://img.jooks.cn/img/20210331184057.png)

## 网络地址转换NAT

![image-20210331185211028](https://img.jooks.cn/img/20210331185211.png)

经过NAT路由器以后，IP分组里的源地址或者目标地址和端口会经过NAT转换表转换。

 ## 子网掩码

网络号（包括子网号）全为1，主机号全为0

![image-20210331191045708](https://img.jooks.cn/img/20210331191045.png)

子网掩码 与 IP地址 逐位相与，就得到子网网络地址。

## 路由转发算法

1. 提取目的IP地址
2. 判断是否直接交付
3. 查询特定主机路由
4. 检测路由表中有无路径（有则按路由表丢给子网）
5. 走默认路由0.0.0.0，给其他路由器
6. 下一跳次数超过TTL时，丢弃，报告转发分组出错。

## CIDR

无分类编址

xxx.xxx.xxx.xxx/len

len表示前缀长度，前面是前缀，剩下的是主机号

使用CIDR时，查找路由表可能匹配到几个匹配结果，英国选择具有最长网络前缀的路由。

## ARP

> 每个主机中都有ARP高速缓存（IP地址与MAC地址的映射）。
>
> 没有缓存时，会进行下面的流程，获取目标IP或下一跳的MAC地址。

#### 局域网内

拿自己的子网掩码跟目标IP做与运算，发现是一个网段。

![image-20210331195613641](https://img.jooks.cn/img/20210331195613.png)

经过交换机大喊一声，IP3是谁？

![image-20210331195804539](https://img.jooks.cn/img/20210331195804.png)

目标IP就返回自己的MAC，然后在数据链路层将MAC填入帧中，发送帧。

#### 不同局域网

拿自己的子网掩码跟目标IP做与运算，发现不是在一个网段内

生成一个广播ARP请求分组，将下一跳IP填入目标IP区域，通过交换机发起广播

![image-20210331200814866](https://img.jooks.cn/img/20210331200814.png)

然后下一跳的节点返回一个单播ARP响应分组，得到下一跳的MAC地址，填入帧中

![image-20210331201028695](https://img.jooks.cn/img/20210331201028.png)

## DHCP

动态主机配置协议，是**应用层**协议，使用客户/服务器方式，客户端和服务端通过广播方式进行交互，基于**UDP**。

主机可用从服务器动态获取IP地址、子网掩码、默认网关、DNS服务器名称与IP地址。

流程：

1. 主机广播 **DHCP发现报文**
2. DHCP服务器广播 **DHCP提供报文**，提供一个IP地址及相关配置
3. 主机广播 **DHCP请求报文**，确认是否使用提供的IP地址
4. DHCP服务器广播 **DHCP确认报文**，正式将IP地址分配给主机

## ICMP

![image-20210331203950048](https://img.jooks.cn/img/20210331203950.png)

类型：

- ICMP差错报告报文
  - 终点不可达
    - 路由器或主机无法交付数据报时，向源点发送终点不可达报文。
  - ~~源点抑制报文~~
  - 时间超过（应用：Traceroute）
    - 路由器收到TTL=0的数据报，直接丢弃，向源点发送时间超过报文。
    - 终点 **在预先规定的时间内** 不能收到一个数据报的 **全部** 数据报片时，将已收到的数据报片都丢弃，并向源点发送时间超过报文。
  - 参数问题
    - 首部字段有问题，就丢弃该数据报，并向源点发送参数问题报文。
  - 改变路由（重定向）
    - 路由器把改变路由报文发送给主机，让主机知道下次数据报发送给另外的路由器。

- ICMP询问报文
  - 回送请求和回答报文（应用：PING）
    - 源点向终点发出询问，终点收到报文后必须给源点发送ICMP回送回答报文
  - 时间戳请求和回答报文
    - 请求某个主机当前日期和时间



不发送ICMP差错报告报文的情况：

1. 对 **ICMP差错报告报文** 不再发送ICMP差错报告报文；
2. 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文；
3. 对具有**组播地址**的数据报都不发送ICMP差错报告报文
4. 对特殊地址不发送





















